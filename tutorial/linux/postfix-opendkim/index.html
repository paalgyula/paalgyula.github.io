<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.34" />
    <meta name="description" content="Paal Gyula&#39;s public knowledgebase based on 11years work experience">
<meta name="author" content="PaÃ¡l Gyula">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />

    <title>Postfix DKIM :: Tutorials for the community</title>
    
    
    <link href="/css/nucleus.css?1517665203" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1517665203" rel="stylesheet">
    <link href="/css/hybrid.css?1517665203" rel="stylesheet">
    <link href="/css/featherlight.min.css?1517665203" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1517665203" rel="stylesheet">
    <link href="/css/auto-complete.css?1517665203" rel="stylesheet">
    <link href="/css/theme.css?1517665203" rel="stylesheet">
    <link href="/css/hugo-theme.css?1517665203" rel="stylesheet">
    
      <link href="/css/theme-mine.css?1517665203" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1517665203"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/tutorial/linux/postfix-opendkim/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">
	<img src="/images/profile-image.png" height=64 alt="" title=""/>
	<p><b class="white">Paal's Knowledgebase</b></p>
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1517665203"></script>
<script type="text/javascript" src="/js/auto-complete.js?1517665203"></script>
<script type="text/javascript">
    
        var baseurl = '\/';
    
</script>
<script type="text/javascript" src="/js/search.js?1517665203"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/tutorial/" title="Tutorials" class="dd-item 
        parent
        
        
        ">
      <a href="/tutorial/">
          <b>1. </b>Tutorials
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/tutorial/linux/" title="Linux Tutorials" class="dd-item 
        parent
        
        
        ">
      <a href="/tutorial/linux/">
          Linux Tutorials
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/tutorial/linux/easy-ssh-tricks/" title="SSH Tricks" class="dd-item ">
        <a href="/tutorial/linux/easy-ssh-tricks/">
        SSH Tricks
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tutorial/linux/letsencrypt-acme-nginx/" title="Letsencrypt Acme Nginx" class="dd-item ">
        <a href="/tutorial/linux/letsencrypt-acme-nginx/">
        Letsencrypt Acme Nginx
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/tutorial/linux/postfix-opendkim/" title="Postfix DKIM" class="dd-item active">
        <a href="/tutorial/linux/postfix-opendkim/">
        Postfix DKIM
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/wiki/" title="Wiki" class="dd-item 
        
        
        
        ">
      <a href="/wiki/">
          <b>5. </b>Wiki
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/wiki/ssh/" title="Secure Shell (SSH)" class="dd-item ">
        <a href="/wiki/ssh/">
        Secure Shell (SSH)
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/wiki/domain-name-system/" title="Domain Name System (DNS)" class="dd-item ">
        <a href="/wiki/domain-name-system/">
        Domain Name System (DNS)
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/wiki/open-mail-relay/" title="Open Mail Relay" class="dd-item ">
        <a href="/wiki/open-mail-relay/">
        Open Mail Relay
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/paalgyula/paalgyula.github.io"><i class='fa fa-fw fa-github'></i> Github repo</a>
              </li>
          
              <li> 
                  <a class="padding" href="/credits"><i class='fa fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <center>
    
    <a class="github-button" href="https://github.com/paalgyula/paalgyula.github.io/archive/master.zip" data-icon="octicon-cloud-download" aria-label="Download paalgyula/paalgyula.github.io on GitHub">Download</a>

    
    <a class="github-button" href="https://github.com/paalgyula/paalgyula.github.io" data-icon="octicon-star" data-show-count="true" aria-label="Star paalgyula/paalgyula.github.io on GitHub">Star</a>

    
    <a class="github-button" href="https://github.com/paalgyula/paalgyula.github.io/fork" data-icon="octicon-repo-forked" data-show-count="true" aria-label="Fork paalgyula/paalgyula.github.io on GitHub">Fork</a>

    <p>Built with <a href="https://github.com/paalgyula/paalgyula.github.io"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>
</center>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='Edit this page' href="https://github.com/paalgyula/paalgyula.github.io/edit/master/site-source/content/tutorial/linux/postfix-opendkim.md" target="blank">
                      <i class="fa fa-code-fork"></i>
                      <span id="top-github-link-text">Edit this page</span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/'>PI Company</a> > <a href='/tutorial/'>Tutorials</a> > <a href='/tutorial/linux/'>Linux Tutorials</a> > Postfix DKIM
          
         
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#install-opendkim">Install OpenDKIM</a></li>
<li><a href="#configure-opendkim">Configure OpenDKIM</a></li>
<li><a href="#generate-the-public-and-private-keys">Generate the public and private keys</a></li>
<li><a href="#add-the-public-key-to-the-domain-s-dns-records">Add the public key to the domain&rsquo;s DNS records</a></li>
<li><a href="#systemd-service-check">Systemd service check</a></li>
<li><a href="#restarting-testing">Restarting/Testing</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Postfix DKIM</h1>
          

        




<h4 id="introduction">Introduction</h4>

<p>The frustration of getting falsely flagged as a spammer is not strange to most of the mail server admins. By excluding the possibility of a compromised server, a false flag is usually caused by one of the following:</p>

<ul>
<li>the server is an open mail relay</li>
<li>the sender&rsquo;s or server&rsquo;s IP address is blacklisted</li>
<li>the server does not have a FQDN and a PTR record</li>
<li>the Sender Policy Framework (SPF) DNS record is missing or it is misconfigured
the DomainKeys Identified Mail (DKIM) implementation is missing or it&rsquo;s not properly set up</li>
<li>These are some of the basic properties that are being checked by the majority of proprietary and open source spam filters (including SpamAssassin). Passing these tests is extremely important for a well configured mail server.</li>
</ul>

<p>This tutorial will focus on installing and configuring <a href="http://opendkim.org/">OpenDKIM</a>: an open source implementation of the DKIM sender authentication system.</p>

<div class="notices tip" ><p>It is assumed that the reader knows how to access the server over SSH, Postfix and Dovecot is already installed and configured, the host name and the FQDN are set up and the SPF record is in place.</p>
</div>


<h4 id="install-opendkim">Install OpenDKIM</h4>

<p>Before starting the installation, a system update is recommended:</p>

<pre><code>sudo apt-get update
sudo apt-get dist-upgrade
</code></pre>

<p>Install OpenDKIM and it&rsquo;s dependencies:</p>

<pre><code>sudo apt-get install opendkim opendkim-tools
</code></pre>

<p>Additional packages will be listed as dependencies, type <strong>yes</strong> and press <em>Enter</em> to continue.</p>

<h4 id="configure-opendkim">Configure OpenDKIM</h4>

<p>A couple of files must be created and edited in order to configure OpenDKIM.</p>

<ul>
<li>Nano will be used as an editor we will use it as a default editor but if you don&rsquo;t like it feel free to use your own command line editor (vi/mcedit)</li>
<li>you can navigate with the arrow keys</li>
<li>exit without saving changes: press CTRL + X and then N</li>
<li>exit and save changes: press CTRL + X and then Y, and finally press Enter</li>
</ul>

<div class="notices warning" ><p><strong>Important</strong>: replace every instance of <strong>example.com</strong> with your own domain in all commands and configuration files. Don&rsquo;t forget to save your files after editing.</p>
</div>


<p>Let&rsquo;s start with the main configuration file:</p>

<pre><code>sudo nano /etc/opendkim.conf
</code></pre>

<p>Append the following lines to the end of the conf file (each parameter is explained below).
<div class="notices tip" ><p>Optionally, you can choose a custom port number for the Socket. Make sure that it&rsquo;s not used by a different application.</p>
</div>
</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">AutoRestart             Yes
AutoRestartRate         <span style="color:#ae81ff">10</span>/1h
UMask                   <span style="color:#ae81ff">002</span>
Syslog                  yes
SyslogSuccess           Yes
LogWhy                  Yes

Canonicalization        relaxed/simple

ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
InternalHosts           refile:/etc/opendkim/TrustedHosts
KeyTable                refile:/etc/opendkim/KeyTable
SigningTable            refile:/etc/opendkim/SigningTable

Mode                    sv
PidFile                 /var/run/opendkim/opendkim.pid
SignatureAlgorithm      rsa-sha256

UserID                  opendkim:opendkim

Socket                  inet:12301@localhost</code></pre></div>

<ul>
<li><strong>AutoRestart</strong>: auto restart the filter on failures</li>
<li><strong>AutoRestartRate</strong>: specifies the filter&rsquo;s maximum restart rate, if restarts begin to happen faster than this rate, the filter will terminate; 10/1h - 10 restarts/hour are allowed at most</li>
<li><strong>UMask</strong>: gives all access permissions to the user group defined by UserID and allows other users to read and execute files, in this case it will allow the creation and modification of a Pid file.</li>
<li><strong>Syslog, SyslogSuccess, *LogWhy</strong>: these parameters enable detailed logging via calls to syslog
Canonicalization: defines the canonicalization methods used at message signing, the simple method allows almost no modification while the relaxed one tolerates minor changes such as
whitespace replacement; relaxed/simple - the message header will be processed with the relaxed algorithm and the body with the simple one</li>
<li><strong>ExternalIgnoreList</strong>: specifies the external hosts that can send mail through the server as one of the signing domains without credentials
InternalHosts: defines a list of internal hosts whose mail should not be verified but signed instead
KeyTable: maps key names to signing keys</li>
<li><strong>SigningTable</strong>: lists the signatures to apply to a message based on the address found in the From: header field</li>
<li><strong>Mode</strong>: declares operating modes; in this case the milter acts as a signer (s) and a verifier (v)</li>
<li><strong>PidFile</strong>: the path to the Pid file which contains the process identification number</li>
<li><strong>SignatureAlgorithm</strong>: selects the signing algorithm to use when creating signatures</li>
<li><strong>UserID</strong>: the opendkim process runs under this user and group</li>
<li><strong>Socket</strong>: the milter will listen on the socket specified here, Posfix will send messages to opendkim for signing and verification through this socket; 12301@localhost defines a TCP socket that listens on localhost, port 12301</li>
</ul>

<p>If you want to use unix socket instead of inet ports, you have to add postfix user to opendkim group:</p>

<pre><code>sudo adduser postfix opendkim
sudo service postfix restart
</code></pre>

<div class="notices tip" ><p>This simple configuration is meant to allow message signing for one or more domains, to learn about other options please go <a href="http://www.opendkim.org/opendkim.conf.5.html">here</a>.</p>
</div>


<p>Connect the milter to Postfix:</p>

<pre><code>sudo nano /etc/default/opendkim
</code></pre>

<p>Add the following line, edit the port number only if a custom one is used:</p>

<pre><code>SOCKET=&quot;inet:12301@localhost&quot;
</code></pre>

<p>Configure postfix to use this milter:</p>

<pre><code>sudo nano /etc/postfix/main.cf
</code></pre>

<p>Make sure that these two lines are present in the Postfix config file and are not commented out:</p>

<pre><code>milter_protocol = 2
milter_default_action = accept
</code></pre>

<p>It is likely that a filter (SpamAssasin, Clamav etc.) is already used by Postfix; if the following parameters are present, just append the opendkim milter to them (milters are separated by a comma), the <strong>port number should be the same as in opendkim.conf</strong>:</p>

<pre><code>smtpd_milters = unix:/spamass/spamass.sock, inet:localhost:12301
non_smtpd_milters = unix:/spamass/spamass.sock, inet:localhost:12301
</code></pre>

<p>If the parameters are missing, define them as follows:</p>

<pre><code>smtpd_milters = inet:localhost:12301
non_smtpd_milters = inet:localhost:12301
</code></pre>

<p>Create a directory structure that will hold the trusted hosts, key tables, signing tables and crypto keys:</p>

<pre><code>sudo mkdir /etc/opendkim
sudo mkdir /etc/opendkim/keys
</code></pre>

<p>Specify trusted hosts:</p>

<pre><code>sudo nano /etc/opendkim/TrustedHosts
</code></pre>

<p>We will use this file to define both ExternalIgnoreList and InternalHosts, messages originating from these hosts, domains and IP addresses will be trusted and signed.</p>

<p>Because our main configuration file declares TrustedHosts as a regular expression file (refile), we can use wildcard patters, *<em>.example.com</em> means that messages coming from example.com&rsquo;s subdomains will be trusted too, not just the ones sent from the root domain.</p>

<p>Customize and add the following lines to the newly created file. Multiple domains can be specified, do not edit the first three lines:</p>

<pre><code>127.0.0.1
localhost
192.168.0.1/24

*.example.com

#*.example.net
#*.example.org
</code></pre>

<p>Create a key table:</p>

<pre><code>sudo nano /etc/opendkim/KeyTable
</code></pre>

<p>A key table contains each selector/domain pair and the path to their private key. Any alphanumeric string can be used as a selector, in this example mail is used and it&rsquo;s not necessary to change it.</p>

<pre><code>mail._domainkey.example.com example.com:mail:/etc/opendkim/keys/example.com/mail.private

#mail._domainkey.example.net example.net:mail:/etc/opendkim/keys/example.net/mail.private
#mail._domainkey.example.org example.org:mail:/etc/opendkim/keys/example.org/mail.private
</code></pre>

<p>Create a signing table:</p>

<pre><code>sudo nano /etc/opendkim/SigningTable
</code></pre>

<p>This file is used for declaring the domains/email addresses and their selectors.</p>

<pre><code>*@example.com mail._domainkey.example.com
#*@example.net mail._domainkey.example.net
#*@example.org mail._domainkey.example.org
</code></pre>

<h4 id="generate-the-public-and-private-keys">Generate the public and private keys</h4>

<p>Change to the keys directory:</p>

<pre><code>cd /etc/opendkim/keys
</code></pre>

<p>Create a separate folder for the domain to hold the keys:</p>

<pre><code>sudo mkdir example.com
cd example.com
</code></pre>

<p>Generate the keys:</p>

<pre><code>sudo opendkim-genkey -s mail -d example.com
</code></pre>

<p>-s specifies the selector and -d the domain, this command will create two files, mail.private is our private key and mail.txt contains the public key.</p>

<p>Change the owner of the private key to opendkim user and fix permissions:</p>

<pre><code>sudo chown opendkim:opendkim mail.private
sudo chown -R opendkim:opendkim /etc/opendkim
sudo chmod -R go-rwx /etc/opendkim/keys
</code></pre>

<h4 id="add-the-public-key-to-the-domain-s-dns-records">Add the public key to the domain&rsquo;s DNS records</h4>

<p>Open mail.txt:</p>

<pre><code>sudo nano -$ mail.txt
</code></pre>

<p>The public key is defined under the p parameter. Do not use the example key below, it&rsquo;s only an illustration and will not work on your server.</p>

<pre><code>mail._domainkey IN TXT &quot;v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAp2SJ7b6/cIW4ljuxnFWKahEB9YnTlIC9Zk1a0J/zhoOZi3o1agMWdpV8bx0FahUFsQFjDIEJV1jITxu4ItajPq8q7JcWqfbwzz0dQHdYHN/QLLurDZWCLvbNS5PwArCsXxWZu2PAga9A9A+tf/Rzi+OTxcA/58Ky+KB4YoR6xdQTMq2RSb&quot;; ----- DKIM key mail for example.com
</code></pre>

<p>Copy that key and add a TXT record to your domain&rsquo;s DNS entries:</p>

<p><strong>Name</strong>: mail._domainkey.example.com.</p>

<p><strong>Text</strong>: &ldquo;v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9&hellip;&rdquo;</p>

<p>Please note that the DNS changes may take a couple of hours to propagate.</p>

<h4 id="systemd-service-check">Systemd service check</h4>

<p>on ubuntu you should modify the <code>/lib/systemd/system/opendkim.service</code> because ubuntu starts the daemon as a unix socket by default.</p>

<p>The file contains an <strong><em>ExecStart</em></strong> line which should look like this:</p>

<pre><code>ExecStart=/usr/sbin/opendkim -P /var/run/opendkim/opendkim.pid -p local:/var/run/opendkim/opendkim.sock -p inet:12301@localhost
</code></pre>

<p>So we need to added a <code>-p inet:12301@localhost</code> parameter for listen on the internet socket too.</p>

<h4 id="restarting-testing">Restarting/Testing</h4>

<p>Restart Postfix and OpenDKIM:</p>

<pre><code>sudo systemctl daemon-reload
sudo service postfix restart
sudo service opendkim restart
</code></pre>

<p>Congratulations! You have successfully configured DKIM for your mail server!</p>

<p>The configuration can be tested by sending an empty email to check-auth@verifier.port25.com and a reply will be received. If everything works correctly you should see DKIM check: pass under Summary of Results.</p>

<pre><code>==========================================================
Summary of Results
==========================================================
SPF check:          pass
DomainKeys check:   neutral
DKIM check:         pass
Sender-ID check:    pass
SpamAssassin check: ham
</code></pre>

<p>Alternatively, you can send a message to a Gmail address that you control, view the received email&rsquo;s headers in your Gmail inbox, dkim=pass should be present in the Authentication-Results header field.</p>

<pre><code>Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of contact@example.com designates --- as permitted sender) smtp.mail=contact@example.com;
       dkim=pass header.i=@example.com;
</code></pre>


<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/tutorial/linux/letsencrypt-acme-nginx/" title="Letsencrypt Acme Nginx"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/wiki/" title="Wiki" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1517665203"></script>
    <script src="/js/perfect-scrollbar.min.js?1517665203"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1517665203"></script>
    <script src="/js/jquery.sticky.js?1517665203"></script>
    <script src="/js/featherlight.min.js?1517665203"></script>
    <script src="/js/html5shiv-printshiv.min.js?1517665203"></script>
    <script src="/js/highlight.pack.js?1517665203"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1517665203"></script>
    <script src="/js/learn.js?1517665203"></script>
    <script src="/js/hugo-learn.js?1517665203"></script>

    <link href="/mermaid/mermaid.css?1517665203" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1517665203"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87027213-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-87027213-2');
</script>
  </body>
</html>

